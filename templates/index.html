{% extends 'base.html' %}
{% block titulo %}Inicio - Registro de Horas{% endblock %}
{% block head_scripts %}
    <!-- Script para actualizar el cronómetro en tiempo real -->
    <script>
    // Calcula y muestra el tiempo transcurrido cada segundo
    {% if en_curso %}
    let segundosTranscurridos = {{ tiempo_transcurrido|int }};
    function actualizarCronometro() {
        segundosTranscurridos++;
        const horas = Math.floor(segundosTranscurridos / 3600);
        const minutos = Math.floor((segundosTranscurridos % 3600) / 60);
        const segundos = segundosTranscurridos % 60;
        const texto = `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`;
        document.getElementById('tiempo_transcurrido').textContent = texto;
    }
    setInterval(actualizarCronometro, 1000);
    {% endif %}
    </script>
{% endblock %}
{% block contenido %}
<h1>Registro de Horas</h1>
<section class="cronometro card">
    <h2>Cronómetro en tiempo real</h2>
    <form method="post" action="{{ url_for('index') }}">
        {% if en_curso %}
            <p>Tiempo transcurrido: <span id="tiempo_transcurrido">{{ '%02d' % ((tiempo_transcurrido | int)//3600) }}:{{ '%02d' % (((tiempo_transcurrido | int) % 3600)//60) }}:{{ '%02d' % ((tiempo_transcurrido | int) % 60) }}</span></p>
            <input type="hidden" name="accion" value="stop">
            <button type="submit" class="btn stop">Detener</button>
        {% else %}
            <p>No hay un cronómetro corriendo actualmente.</p>
            <input type="hidden" name="accion" value="start">
            <label for="descripcion">Descripción (opcional):</label>
            <input type="text" id="descripcion" name="descripcion" placeholder="¿Qué estás haciendo?">
            <button type="submit" class="btn start">Iniciar</button>
        {% endif %}
    </form>
</section>

<section class="manual card">
    <h2>Registro manual</h2>
    <p>Utiliza este formulario para añadir horas manualmente o cancelar excesos/faltantes.</p>
    <form method="post" action="{{ url_for('index') }}">
        <input type="hidden" name="accion" id="accion_manual" value="manual">
        <label for="fecha_manual">Fecha:</label>
        <input type="date" id="fecha_manual" name="fecha_manual" required>
        <label for="horas_manual">Horas:</label>
        <input type="number" id="horas_manual" name="horas_manual" min="0" value="0" required>
        <label for="minutos_manual">Minutos:</label>
        <input type="number" id="minutos_manual" name="minutos_manual" min="0" max="59" value="0" required>
        <label for="descripcion_manual">Descripción (opcional):</label>
        <input type="text" id="descripcion_manual" name="descripcion" placeholder="Descripción de la actividad">
        <div class="acciones-manuales">
            <button type="submit" class="btn manual" onclick="document.getElementById('accion_manual').value='manual'">Registrar</button>
            <button type="submit" class="btn cancel" onclick="document.getElementById('accion_manual').value='cancelar'">Cancelar horas</button>
        </div>
    </form>
    <p class="nota">Horas máximas diarias configuradas: {{ (minutos_maximos//60) }}h {{ (minutos_maximos%60) }}m.</p>
    <p class="ayuda">Para cancelar horas sobrantes o faltantes introduce el valor y presiona "Cancelar horas". El valor será restado o sumado de tu saldo.</p>
</section>
{% endblock %}